services:
    minio:
        image: minio/minio
        ports:
            - '9010:9000'
            - '9011:9001'
        environment:
            MINIO_ROOT_USER: minioadmin
            MINIO_ROOT_PASSWORD: minioadmin
        command: server /data --console-address ":9001"
        healthcheck:
            test: ['CMD', 'curl', '-f', 'http://localhost:9000/minio/health/live']
            interval: 5s
            timeout: 5s
            retries: 5

    minio-init:
        image: minio/mc
        depends_on:
            minio:
                condition: service_healthy
        entrypoint: >
            /bin/sh -c "
            mc alias set local http://minio:9000 minioadmin minioadmin;
            mc mb local/documents;
            mc mb local/files;
            mc anonymous set download local/documents;
            mc anonymous set download local/files;
            exit 0;
            "

    app:
        build:
            context: .
            dockerfile: Dockerfile
        ports:
            - '3334:3333'
        environment:
            STORAGE_TYPE: aws
            S3_ENDPOINT: http://minio:9000
            S3_FORCE_PATH_STYLE: 'true'
            S3_REGION: us-east-1
            API_KEY: test-api-key-e2e
            AWS_ACCESS_KEY_ID: minioadmin
            AWS_SECRET_ACCESS_KEY: minioadmin
            AVAILABLE_BUCKETS: documents,files
            PORT: 3333
        depends_on:
            minio-init:
                condition: service_completed_successfully
        healthcheck:
            test: ['CMD', 'wget', '--spider', '-q', 'http://localhost:3333/health-check']
            interval: 5s
            timeout: 5s
            retries: 10
            start_period: 15s
